#!/bin/bash

resolve_alias() {
    local input_path="$1"
    resolved="$input_path"

    # 检查是否为 Finder Alias
    if xattr -p com.apple.FinderInfo "$input_path" &>/dev/null; then
        # 使用 osascript 解析 Finder Alias
        resolved=$(osascript -e "
            on resolveAlias(theAlias)
                tell application \"Finder\"
                    set theItem to (original item of theAlias) as text
                end tell
                return POSIX path of theItem
            end resolveAlias

            set inputAlias to POSIX file \"$input_path\" as alias
            resolveAlias(inputAlias)" 2>/dev/null) 
        
        # 去掉换行符，确保路径可用
        resolved=$(echo "$resolved" | tr -d '\n' | xargs)
        # 如果是文件夹，去掉末尾的 /
        if [[ -d "$resolved" ]]; then
            resolved="${resolved%/}"
        fi
    fi
}

if [[ $1 == "-r" ]]; then
    [[ -d $HOME/sh/tools/Library/resolve_alias ]] && rm -r $HOME/sh/tools/Library/resolve_alias
    exit 0
fi

if [[ ! -e "$1" ]]; then
    echo "$1 不存在" >&2
    exit 1
fi

if [[ -d "$1" ]]; then
    resolved="$1"
else
    mkdir -p $HOME/sh/tools/Library/resolve_alias
    cd $HOME/sh/tools
    
    temp_local="temp"
    while [[ -d "$HOME/sh/tools/Library/resolve_alias/$temp_local" ]]; do
    temp_local="temp"${i}
    ((i++))
    done
    mkdir Library/resolve_alias/$temp_local

    filename=$(basename "$1")
    if [[ "$filename" == *.* && "$filename" != .* ]]; then
       ext=".${filename##*.}"
    fi

    cp "$1" ./Library/resolve_alias/$temp_local/  
    mv "Library/resolve_alias/$temp_local/$filename" "Library/resolve_alias/$temp_local/file$ext"

    resolve_alias "Library/resolve_alias/$temp_local/file$ext"

    if [[ "$resolved" == "Library/resolve_alias/$temp_local/file$ext" ]]; then
        resolved="$1"
    elif [[ -z $resolved ]]; then
        resolved="$1"
    fi
    
    [[ $2 != -e ]] && rm -r Library/resolve_alias/$temp_local
    [[ $2 == -r ]] && rm -r Library/resolve_alias
fi

echo "$resolved"


